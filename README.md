# tcp_spoof

tcp_spoof是基于ip spoof的tcp传输协议。通过ip spoof更改ip报头的源地址，隐藏真正的通信双方，躲避流量统计。在修改过报头的ip协议上面建立可靠的连接，达到类似与tcp/ip通信效果。

##  公网ip <---> 公网ip
一方作为服务器端，在ip层监听TCP协议的指定端口，等待连接。另一方作为客户端，同样需要在IP层监听特定端口，然后用随机地址作为源地址，随机端口作为源端口，向服务器端的目标端口发送请求连接的spoof TCP报文，报文内容包括客户端的真实IP地址和监听端口号且经过加密。服务器端在收到客户端报文后解密，提取出客户端的IP地址和端口号，并随机生成一个session id，作为通信双方的凭证，服务器端将此session id发送给通过一个随机源地址和随机端口的加密报文发送给客户端，后面只需要报文中指定该session id，双方就可以发送随机的源地址源端口的IP报文了。这样一个IP层的spoof协议就建立好了，后面只需要在此基础上建立类似于TCP的连接协议就可以了。


## 公网IP <---> NAT子网
对于这种，NAT 子网下面的主机需要进行地址转换，在公网看到的是NAT主机的地址，不需要进行IP spoof，而外网IP要想发送报文到NAT子网，通常需要打洞。从NAT子网发送到的公网主机的报文需要是常规的报文，而公网主机发送给NAT子网的主机可以是修改过源地址的报文。
这里同样将公网IP的主机作为服务器，NAT子网的主机作为客户端，具体步骤：

1. 客户端与服务器端建立常规连接，约定通信的session id。
2. 客户端用常规UDP报文向服务器端发送打洞请求，服务器端将自己即将使用的随机源地址和端口发送给客户端，服务客户端用之前的UDP端口向服务器发送过来的地址和端口发送数据，同时服务器端也用之前指定的随机源地址和端口向受到打动请求的UDP地址发送包含session id的报文，直到客户端收到随机源地址发送过来的数据，打洞成功，之后客户端还需要定时向随机地址和端口发送数据。如果需要，还可以用TCP打洞。
3. 客户端发送到服务器的数据走常规连接，服务器端发送到客户端的数据走spoof连接，双向连接建立好了，再加上包排序，丢包重发等就可以建立可靠连接了。


## 淹没真实地址

由于目标地址不能被隐藏，总会有少部分的数据包暴露真实的通讯地址，如果不介意流量，可以同时向多个目标地址发送报文，将真实的数据包隐藏在这其中，使之更难被发现。


## 参考项目
[udp2raw-tunnel](https://github.com/wangyu-/udp2raw-tunnel)

[kcptun](https://github.com/xtaci/kcptun)


